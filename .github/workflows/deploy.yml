name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    vars:
      IMAGE_NAME_BASE: ghcr.io/${{ github.repository_owner }}/${{ github.repository | lower }}
      DOCKER_IMAGE_NAME: ${{ vars.IMAGE_NAME_BASE }}:latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üîë Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.PAT }}

      - name: üî® Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ vars.DOCKER_IMAGE_NAME }}
          file: ./Dockerfile.prod
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üöÄ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "--- –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Ä–æ–±–æ—á–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó ---"
            cd ${{ secrets.PROD_COMPOSE_PATH }}

            echo "--- –õ–æ–≥—ñ–Ω –¥–æ GitHub Container Registry –Ω–∞ VPS ---"
            # –õ–æ–≥—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è –¥–ª—è –±–µ–∑–ø–µ–∫–∏
            echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            echo "--- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—É —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ ---"
            # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–º—ñ–Ω–Ω—É DOCKER_IMAGE_NAME –¥–ª—è docker-compose
            docker compose -f docker-compose.prod.yml --env-file .env.prod pull backend
            docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --remove-orphans backend
            
            echo "--- –û—á–∏—â–µ–Ω–Ω—è (–≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–∏—Ö –æ–±—Ä–∞–∑—ñ–≤) ---"
            docker image prune -f
            
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"