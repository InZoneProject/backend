name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Docker Image Name
        run: |
          # –ë–µ—Ä–µ–º–æ –Ω–∞–∑–≤—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (–Ω–∞–ø—Ä. User/Repo), –ø–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ –Ω–∏–∂–Ω—ñ–π —Ä–µ–≥—ñ—Å—Ç—Ä
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          # –§–æ—Ä–º—É—î–º–æ –ø–æ–≤–Ω—É –Ω–∞–∑–≤—É –æ–±—Ä–∞–∑—É
          IMAGE_NAME=ghcr.io/$REPO_LOWER:latest
          # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ü–µ –≤ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –∫—Ä–æ–∫—ñ–≤
          echo "DOCKER_IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "Image name will be: $IMAGE_NAME"

      - name: üèóÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.PAT }}

      - name: üî® Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}
          file: ./Dockerfile.prod
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üöÄ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "--- –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Ä–æ–±–æ—á–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó ---"
            cd ${{ secrets.PROD_COMPOSE_PATH }}

            echo "--- –õ–æ–≥—ñ–Ω –¥–æ GitHub Container Registry –Ω–∞ VPS ---"
            echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            echo "--- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—É: ${{ env.DOCKER_IMAGE_NAME }} ---"
            
            # –û–Ω–æ–≤–ª—é—î–º–æ —Å–µ—Ä–≤—ñ—Å backend
            # –ú–∏ –ø–µ—Ä–µ–¥–∞—î–º–æ —ñ–º'—è –æ–±—Ä–∞–∑—É —è–∫ –∑–º—ñ–Ω–Ω—É –æ—Ç–æ—á–µ–Ω–Ω—è –ø—Ä—è–º–æ –≤ –∫–æ–º–∞–Ω–¥—É docker compose
            DOCKER_IMAGE_NAME=${{ env.DOCKER_IMAGE_NAME }} docker compose -f docker-compose.prod.yml --env-file .env.prod pull backend
            
            DOCKER_IMAGE_NAME=${{ env.DOCKER_IMAGE_NAME }} docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --remove-orphans backend
            
            echo "--- –û—á–∏—â–µ–Ω–Ω—è ---"
            docker image prune -f
            
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"